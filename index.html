<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>우리 가족 통합 관리 시스템</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      overflow-x: hidden;
    }
    .container { max-width: 1400px; margin: 0 auto; padding: 15px; min-height: 100vh; }
    .header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 20px; margin-bottom: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }
    .login-container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 40px; text-align: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      max-width: 450px; margin: 80px auto;
    }
    .main-app { display: none; }
    .nav-tabs { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
    .nav-tab {
      background: rgba(255, 255, 255, 0.8);
      border: none; padding: 10px 18px;
      border-radius: 25px; cursor: pointer; transition: all 0.3s ease;
      font-weight: 500; font-size: 14px;
    }
    .nav-tab:hover { background: rgba(102, 126, 234, 0.2); }
    .nav-tab.active { background: #667eea; color: white; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }
    .content-section { display: none; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 15px; padding: 25px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); min-height: 400px; }
    .content-section.active { display: block; animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
    .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px 16px; border: 2px solid #e1e5e9; border-radius: 10px; font-size: 14px; transition: all 0.3s ease; }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
    .btn {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white; border: none; padding: 12px 24px; border-radius: 25px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: inline-block;
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4); }
    .btn:active { transform: translateY(0); }
    .btn-danger { background: linear-gradient(135deg, #ff6b6b, #ee5a24); padding: 8px 16px; font-size: 12px; }
    .btn-success { background: linear-gradient(135deg, #27ae60, #2ecc71); }
    .btn-info { background: linear-gradient(135deg, #3498db, #2980b9); }
    .card { background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 16px; border-left: 4px solid #667eea; transition: all 0.3s ease; }
    .card:hover { transform: translateX(3px); box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); }
    .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 20px; }
    .calendar-day { background: #f8f9fa; border: 1px solid #e1e5e9; border-radius: 8px; padding: 8px; min-height: 80px; font-size: 12px; }
    .calendar-day.today { background: #667eea; color: white; }
    .calendar-header { background: #667eea; color: white; text-align: center; padding: 12px 8px; font-weight: bold; border-radius: 8px; }
    .expense-item { display: flex; justify-content: space-between; align-items: flex-start; padding: 16px; background: #f8f9fa; border-radius: 10px; margin-bottom: 12px; }
    .amount { font-weight: bold; color: #e74c3c; }
    .income { color: #27ae60; }
    .user-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
    .admin-badge { background: #e74c3c; color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px; margin-left: 10px; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 25px; border-radius: 15px; text-align: center; }
    .stat-number { font-size: 2.2em; font-weight: bold; margin-bottom: 8px; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); z-index: 1000; }
    .modal-content { background: white; border-radius: 15px; padding: 30px; max-width: 500px; width: 90%; margin: 5% auto; position: relative; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); }
    .close { position: absolute; right: 20px; top: 20px; font-size: 28px; cursor: pointer; color: #999; }
    .close:hover { color: #333; }
    .sheets-status { background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; padding: 10px 15px; border-radius: 10px; margin-bottom: 20px; text-align: center; font-size: 14px; }
    .sheets-status.disconnected { background: linear-gradient(135deg, #e74c3c, #c0392b); }
    @media (max-width: 768px) {
      .container { padding: 10px; }
      .nav-tabs { justify-content: center; }
      .stats-grid { grid-template-columns: 1fr; }
      .calendar { gap: 4px; }
      .calendar-day { min-height: 60px; }
      .expense-item { flex-direction: column; gap: 10px; }
      .user-info { flex-direction: column; text-align: center; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- 로그인 화면 -->
    <div id="loginScreen" class="login-container">
      <h2 style="margin-bottom: 30px; color: #333;">우리 가족 통합 관리 시스템</h2>
      <div class="form-group">
        <label for="loginId">아이디</label>
        <input type="text" id="loginId" placeholder="아이디를 입력하세요" />
      </div>
      <div class="form-group">
        <label for="loginPassword">비밀번호</label>
        <input type="password" id="loginPassword" placeholder="비밀번호를 입력하세요" />
      </div>
      <button class="btn" id="loginBtn">로그인</button>
      <p style="margin-top: 20px; font-size: 12px; color: #666;">
        데모 계정: admin/admin (운영자), dad/dad (아빠), mom/mom (엄마), son/son (아들)
      </p>
    </div>

    <!-- 메인 애플리케이션 -->
    <div id="mainApp" class="main-app">
      <div class="header">
        <div id="sheetsStatus" class="sheets-status disconnected">
          📊 Google Sheets 연결 안됨 - "Sheets 연결" 버튼을 클릭하세요
        </div>
        <div class="user-info">
          <div>
            <h1>우리 가족 통합 관리 시스템</h1>
            <span id="welcomeMessage"></span>
            <span id="adminBadge" class="admin-badge" style="display: none;">운영자</span>
          </div>
          <div>
            <button class="btn btn-success" id="btnSheets">📊 Sheets 연결</button>
            <button class="btn btn-info" id="btnSync">🔄 동기화</button>
            <button class="btn" id="btnLogout">로그아웃</button>
          </div>
        </div>
        <div class="nav-tabs">
          <button class="nav-tab active" data-section="dashboard">대시보드</button>
          <button class="nav-tab" data-section="blog">가족 블로그</button>
          <button class="nav-tab" data-section="budget">가계부</button>
          <button class="nav-tab" data-section="calendar">일정표</button>
          <button class="nav-tab" data-section="finance">재정현황</button>
          <button class="nav-tab" id="adminTab" style="display: none;" data-section="admin">관리자</button>
        </div>
      </div>

      <!-- 대시보드 -->
      <div id="dashboard" class="content-section active">
        <h2>대시보드</h2>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number" id="totalBudget">₩0</div>
            <div>이번 달 지출</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="blogCount">0</div>
            <div>총 블로그 포스트</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="scheduleCount">0</div>
            <div>이번 주 일정</div>
          </div>
        </div>
        <h3>최근 활동</h3>
        <div id="recentActivity"></div>
      </div>

      <!-- 가족 블로그 -->
      <div id="blog" class="content-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2>가족 블로그</h2>
          <button class="btn" id="btnNewPost">새 포스트 작성</button>
        </div>
        <div id="blogPosts"></div>
      </div>

      <!-- 가계부 -->
      <div id="budget" class="content-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2>가계부</h2>
          <button class="btn" id="btnNewBudget">수입/지출 추가</button>
        </div>
        <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr);">
          <div class="stat-card">
            <div class="stat-number income" id="totalIncome">₩0</div>
            <div>총 수입</div>
          </div>
          <div class="stat-card">
            <div class="stat-number amount" id="totalExpense">₩0</div>
            <div>총 지출</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="netAmount">₩0</div>
            <div>순수입</div>
          </div>
        </div>
        <div id="budgetItems"></div>
      </div>

      <!-- 일정표 -->
      <div id="calendar" class="content-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2>일정표</h2>
          <button class="btn" id="btnNewSchedule">새 일정 추가</button>
        </div>
        <div id="calendarView"></div>
      </div>

      <!-- 재정현황 -->
      <div id="finance" class="content-section">
        <h2>재정현황 게시판</h2>
        <div id="financeBoard"></div>
      </div>

      <!-- 관리자 페이지 -->
      <div id="admin" class="content-section">
        <h2>관리자 페이지</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
          <div class="card">
            <h3>사용자 관리</h3>
            <div id="userList"></div>
          </div>
          <div class="card">
            <h3>시스템 통계</h3>
            <div id="systemStats"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 블로그 모달 -->
  <div id="blogModal" class="modal">
    <div class="modal-content">
      <span class="close" data-close="blogModal">&times;</span>
      <h3>새 블로그 포스트 작성</h3>
      <div class="form-group">
        <label>제목</label>
        <input type="text" id="blogTitle" />
      </div>
      <div class="form-group">
        <label>내용</label>
        <textarea id="blogContent" rows="6"></textarea>
      </div>
      <button class="btn" id="btnSavePost">포스트 작성</button>
    </div>
  </div>

  <!-- 가계부 모달 -->
  <div id="budgetModal" class="modal">
    <div class="modal-content">
      <span class="close" data-close="budgetModal">&times;</span>
      <h3>수입/지출 추가</h3>
      <div class="form-group">
        <label>구분</label>
        <select id="budgetType">
          <option value="income">수입</option>
          <option value="expense">지출</option>
        </select>
      </div>
      <div class="form-group">
        <label>내용</label>
        <input type="text" id="budgetDescription" />
      </div>
      <div class="form-group">
        <label>금액</label>
        <input type="number" id="budgetAmount" />
      </div>
      <div class="form-group">
        <label>카테고리</label>
        <select id="budgetCategory">
          <option value="식비">식비</option>
          <option value="교통비">교통비</option>
          <option value="생활용품">생활용품</option>
          <option value="의료비">의료비</option>
          <option value="교육비">교육비</option>
          <option value="기타">기타</option>
        </select>
      </div>
      <button class="btn" id="btnSaveBudget">추가</button>
    </div>
  </div>

  <!-- 일정 모달 -->
  <div id="scheduleModal" class="modal">
    <div class="modal-content">
      <span class="close" data-close="scheduleModal">&times;</span>
      <h3>새 일정 추가</h3>
      <div class="form-group">
        <label>제목</label>
        <input type="text" id="scheduleTitle" />
      </div>
      <div class="form-group">
        <label>날짜</label>
        <input type="date" id="scheduleDate" />
      </div>
      <div class="form-group">
        <label>시간</label>
        <input type="time" id="scheduleTime" />
      </div>
      <div class="form-group">
        <label>내용</label>
        <textarea id="scheduleDescription" rows="3"></textarea>
      </div>
      <button class="btn" id="btnSaveSchedule">일정 추가</button>
    </div>
  </div>

  <script>
    // ===== 전역 상태 =====
    let currentUser = null;
    const users = {
      admin: { password: 'admin', name: '관리자', role: 'admin' },
      dad: { password: 'dad', name: '아빠', role: 'user' },
      mom: { password: 'mom', name: '엄마', role: 'user' },
      son: { password: 'son', name: '아들', role: 'user' },
    };
    let blogPosts = [];
    let budgetItems = [];
    let schedules = [];

    // Google Sheets 연동
    let sheetsApiUrl = '';

    // ===== 유틸 =====
    function saveData() {
      try {
        const data = {
          blogPosts,
          budgetItems,
          schedules,
          lastSaved: new Date().toISOString(),
        };
        localStorage.setItem('familyData', JSON.stringify(data));
        console.log('✅ 데이터 저장 완료');
      } catch (error) {
        console.error('❌ 저장 오류:', error);
      }
    }

    function loadData() {
      try {
        const data = localStorage.getItem('familyData');
        if (data) {
          const parsed = JSON.parse(data);
          blogPosts = (parsed.blogPosts || []).map((post) => ({ ...post, date: post.date ? new Date(post.date) : null }));
          budgetItems = (parsed.budgetItems || []).map((item) => ({ ...item, date: item.date ? new Date(item.date) : null }));
          schedules = (parsed.schedules || []).map((s) => ({ ...s, date: s.date ? new Date(s.date) : null }));
          console.log('✅ 기존 데이터 로드됨');
        } else {
          // 초기 데모 데이터
          blogPosts = [
            { id: 1, title: '가족 여행 계획', content: '이번 여름휴가 계획을 세워보았습니다.', author: '엄마', date: new Date('2025-08-01'), authorId: 'mom' },
          ];
          budgetItems = [
            { id: 1, type: 'expense', description: '마트 장보기', amount: 150000, category: '식비', author: '엄마', date: new Date('2025-08-20'), authorId: 'mom' },
            { id: 2, type: 'income', description: '월급', amount: 3000000, category: '급여', author: '아빠', date: new Date('2025-08-01'), authorId: 'dad' },
          ];
          schedules = [
            { id: 1, title: '가족 외식', date: new Date('2025-08-25'), time: '18:00', description: '저녁 외식', author: '엄마', authorId: 'mom' },
          ];
          saveData();
          console.log('✅ 초기 데모 데이터 생성됨');
        }
      } catch (error) {
        console.error('❌ 로드 오류:', error);
      }
    }

    function updateSheetsStatus(connected) {
      const statusEl = document.getElementById('sheetsStatus');
      if (!statusEl) return;
      if (connected) {
        statusEl.textContent = '📊 Google Sheets 연결됨 - 가족 간 데이터 공유 가능!';
        statusEl.className = 'sheets-status';
      } else {
        statusEl.textContent = '📊 Google Sheets 연결 안됨 - "Sheets 연결" 버튼을 클릭하세요';
        statusEl.className = 'sheets-status disconnected';
      }
    }

    async function testConnection() {
      if (!sheetsApiUrl) return;
      try {
        const response = await fetch(sheetsApiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'test' }),
        });
        const result = await response.json();
        if (result.success) {
          updateSheetsStatus(true);
          console.log('✅ Google Sheets 연결 성공');
        } else {
          updateSheetsStatus(false);
          console.log('❌ Google Sheets 연결 실패');
        }
      } catch (error) {
        console.error('❌ 연결 테스트 오류:', error);
        updateSheetsStatus(false);
      }
    }

    async function saveToSheets(type, data) {
      if (!sheetsApiUrl) {
        console.log('Google Sheets URL이 설정되지 않음');
        return false;
      }
      try {
        const response = await fetch(sheetsApiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'save', type, data }),
        });
        const result = await response.json();
        if (result.success) {
          console.log('✅ Google Sheets 저장 성공:', type);
          return true;
        }
        console.error('❌ Sheets 저장 실패:', result.error);
        return false;
      } catch (error) {
        console.error('❌ Sheets 저장 오류:', error);
        return false;
      }
    }

    async function syncWithSheets() {
      if (!sheetsApiUrl) {
        alert('❌ Google Sheets URL을 먼저 설정해주세요.\n\n"📊 Sheets 연결" 버튼을 클릭하세요.');
        return;
      }
      try {
        const response = await fetch(sheetsApiUrl, {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'load' }),
        });
        const result = await response.json();
        if (result.success && result.data) {
          parseSheetData(result.data);
          renderAll();
          alert('🔄 동기화 완료!\n\nGoogle Sheets에서 최신 데이터를 불러왔습니다.');
        } else {
          alert('❌ 동기화 실패\n\nGoogle Sheets에서 데이터를 불러올 수 없습니다.');
        }
      } catch (error) {
        console.error('동기화 오류:', error);
        alert('❌ 동기화 실패\n\n' + error.message);
      }
    }

    function parseSheetData(sheetData) {
      const newBlogPosts = [];
      const newBudgetItems = [];
      const newSchedules = [];
      (sheetData || []).slice(1).forEach((row) => {
        if (row[1] && row[2]) {
          try {
            const data = JSON.parse(row[2]);
            if (row[1] === 'blog') newBlogPosts.push({ ...data, date: new Date(data.date) });
            else if (row[1] === 'budget') newBudgetItems.push({ ...data, date: new Date(data.date) });
            else if (row[1] === 'schedule') newSchedules.push({ ...data, date: new Date(data.date) });
          } catch (e) {
            console.error('데이터 파싱 오류:', e);
          }
        }
      });
      blogPosts = mergeById(blogPosts, newBlogPosts);
      budgetItems = mergeById(budgetItems, newBudgetItems);
      schedules = mergeById(schedules, newSchedules);
      saveData();
    }

    function mergeById(existing, incoming) {
      const map = new Map(existing.map((x) => [x.id, x]));
      for (const it of incoming) if (!map.has(it.id)) map.set(it.id, it);
      return Array.from(map.values());
    }

    // ===== 인증 =====
    function loginUser() {
      const id = document.getElementById('loginId').value.trim();
      const pw = document.getElementById('loginPassword').value;
      if (users[id] && users[id].password === pw) {
        currentUser = { id, ...users[id] };
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        document.getElementById('welcomeMessage').textContent = currentUser.name + '님 환영합니다!';
        if (currentUser.role === 'admin') {
          document.getElementById('adminBadge').style.display = 'inline-block';
          document.getElementById('adminTab').style.display = 'block';
        }
        const savedUrl = localStorage.getItem('sheetsApiUrl');
        if (savedUrl) { sheetsApiUrl = savedUrl; updateSheetsStatus(true); } else { updateSheetsStatus(false); }
        loadData();
        renderAll();
        if (currentUser.role === 'admin') loadAdminPanel();
      } else {
        alert('아이디 또는 비밀번호가 올바르지 않습니다.');
      }
    }

    function logoutUser() {
      currentUser = null;
      document.getElementById('loginScreen').style.display = 'block';
      document.getElementById('mainApp').style.display = 'none';
      document.getElementById('adminBadge').style.display = 'none';
      document.getElementById('adminTab').style.display = 'none';
      document.getElementById('loginId').value = '';
      document.getElementById('loginPassword').value = '';
      showTab('dashboard');
    }

    // ===== 탭 & 렌더 =====
    function showTab(section) {
      document.querySelectorAll('.content-section').forEach((s) => s.classList.remove('active'));
      document.querySelectorAll('.nav-tab').forEach((t) => t.classList.remove('active'));
      const target = document.getElementById(section);
      if (target) target.classList.add('active');
      const btn = document.querySelector(`.nav-tab[data-section="${section}"]`);
      if (btn) btn.classList.add('active');
    }

    function renderAll() {
      updateDashboard();
      loadBlogPosts();
      loadBudgetItems();
      loadSchedules();
      loadFinanceBoard();
    }

    function updateDashboard() {
      const now = new Date();
      const currentMonth = now.getMonth();
      const monthlyExpenses = budgetItems
        .filter((i) => i && i.type === 'expense' && i.date && i.date.getMonth() === currentMonth)
        .reduce((sum, i) => sum + (Number(i.amount) || 0), 0);
      const totalBudgetEl = document.getElementById('totalBudget');
      if (totalBudgetEl) totalBudgetEl.textContent = '₩' + monthlyExpenses.toLocaleString();
      const blogCountEl = document.getElementById('blogCount');
      if (blogCountEl) blogCountEl.textContent = blogPosts.length;
      const scheduleCountEl = document.getElementById('scheduleCount');
      if (scheduleCountEl) scheduleCountEl.textContent = schedules.length;

      const recentActivity = document.getElementById('recentActivity');
      if (!recentActivity) return;
      recentActivity.innerHTML = '';
      const recent = [
        ...blogPosts.slice(-3).map((data) => ({ type: 'blog', data })),
        ...budgetItems.slice(-3).map((data) => ({ type: 'budget', data })),
        ...schedules.slice(-3).map((data) => ({ type: 'schedule', data })),
      ]
        .filter((a) => a.data && a.data.date)
        .sort((a, b) => new Date(b.data.date) - new Date(a.data.date))
        .slice(0, 5);

      recent.forEach((activity) => {
        const card = document.createElement('div');
        card.className = 'card';
        let content = '';
        if (activity.type === 'blog') {
          content = `${activity.data.author || '익명'}님이 "${activity.data.title || '제목없음'}" 블로그 포스트를 작성했습니다.`;
        } else if (activity.type === 'budget') {
          const type = activity.data.type === 'income' ? '수입' : '지출';
          content = `${activity.data.author || '익명'}님이 ${type} "${activity.data.description || '설명없음'}"을(를) ₩${(activity.data.amount || 0).toLocaleString()}으로 기록했습니다.`;
        } else {
          content = `${activity.data.author || '익명'}님이 "${activity.data.title || '제목없음'}" 일정을 추가했습니다.`;
        }
        const dateStr = activity.data.date ? new Date(activity.data.date).toLocaleDateString() : '날짜없음';
        card.innerHTML = `<p><strong>${content}</strong></p><small style="color:#666;">${dateStr}</small>`;
        recentActivity.appendChild(card);
      });
    }

    function loadBlogPosts() {
      const container = document.getElementById('blogPosts');
      if (!container) return; container.innerHTML = '';
      (blogPosts || [])
        .slice()
        .sort((a, b) => (b.date ? new Date(b.date) : 0) - (a.date ? new Date(a.date) : 0))
        .forEach((post) => {
          const canEdit = currentUser && (currentUser.role === 'admin' || currentUser.id === post.authorId);
          const el = document.createElement('div');
          el.className = 'card';
          const title = post.title || '제목없음';
          const content = post.content || '내용없음';
          const author = post.author || '익명';
          const date = post.date ? new Date(post.date).toLocaleDateString() : '날짜없음';
          el.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;">
              <div style="flex:1;">
                <h3 style="margin-bottom:10px;">${title}</h3>
                <p style="margin-bottom:10px;">${content}</p>
                <small style="color:#666;">작성자: ${author} | 날짜: ${date}</small>
              </div>
              ${canEdit ? `<button class="btn btn-danger" data-remove-post="${post.id}">삭제</button>` : ''}
            </div>`;
          container.appendChild(el);
        });
    }

    function loadBudgetItems() {
      const container = document.getElementById('budgetItems');
      if (!container) return; container.innerHTML = '';
      let totalIncome = 0, totalExpense = 0;
      (budgetItems || [])
        .slice()
        .sort((a, b) => (b.date ? new Date(b.date) : 0) - (a.date ? new Date(a.date) : 0))
        .forEach((item) => {
          if (item.type === 'income') totalIncome += Number(item.amount) || 0; else totalExpense += Number(item.amount) || 0;
          const canEdit = currentUser && (currentUser.role === 'admin' || currentUser.id === item.authorId);
          const el = document.createElement('div');
          el.className = 'expense-item';
          const dateStr = item.date ? new Date(item.date).toLocaleDateString() : '날짜없음';
          el.innerHTML = `
            <div>
              <strong>${item.description || '설명없음'}</strong><br/>
              <small>카테고리: ${item.category || '기타'} | ${item.author || '익명'} | ${dateStr}</small>
            </div>
            <div style="text-align:right;">
              <div class="${item.type === 'income' ? 'income' : 'amount'}">${item.type === 'income' ? '+' : '-'}₩${(item.amount || 0).toLocaleString()}</div>
              ${canEdit ? `<button class="btn btn-danger" data-remove-budget="${item.id}">삭제</button>` : ''}
            </div>`;
          container.appendChild(el);
        });
      const ti = document.getElementById('totalIncome'); if (ti) ti.textContent = '₩' + totalIncome.toLocaleString();
      const te = document.getElementById('totalExpense'); if (te) te.textContent = '₩' + totalExpense.toLocaleString();
      const net = document.getElementById('netAmount'); if (net) net.textContent = '₩' + (totalIncome - totalExpense).toLocaleString();
    }

    function loadSchedules() {
      const container = document.getElementById('calendarView');
      if (!container) return; container.innerHTML = '';
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth();
      const calendarHeader = document.createElement('h3');
      calendarHeader.textContent = `${year}년 ${month + 1}월`;
      calendarHeader.style.textAlign = 'center';
      calendarHeader.style.marginBottom = '20px';
      container.appendChild(calendarHeader);
      const daysOfWeek = ['일', '월', '화', '수', '목', '금', '토'];
      const grid = document.createElement('div'); grid.className = 'calendar';
      daysOfWeek.forEach((d) => { const h = document.createElement('div'); h.className = 'calendar-header'; h.textContent = d; grid.appendChild(h); });
      const firstDay = new Date(year, month, 1).getDay();
      const lastDate = new Date(year, month + 1, 0).getDate();
      for (let i = 0; i < firstDay; i++) { const empty = document.createElement('div'); empty.className = 'calendar-day'; grid.appendChild(empty); }
      const today = new Date();
      for (let date = 1; date <= lastDate; date++) {
        const cell = document.createElement('div'); cell.className = 'calendar-day';
        if (date === today.getDate() && month === today.getMonth() && year === today.getFullYear()) cell.classList.add('today');
        cell.innerHTML = `<strong>${date}</strong>`;
        const daySchedules = (schedules || []).filter((s) => s.date && s.date.getDate() === date && s.date.getMonth() === month && s.date.getFullYear() === year);
        daySchedules.forEach((s) => {
          const d = document.createElement('div');
          d.style.cssText = 'font-size:10px;background:#667eea;color:white;padding:2px 4px;border-radius:4px;margin-top:2px;';
          d.textContent = `${s.time || ''} ${s.title || ''}`;
          cell.appendChild(d);
        });
        grid.appendChild(cell);
      }
      container.appendChild(grid);

      const list = document.createElement('div');
      list.style.marginTop = '30px';
      list.innerHTML = '<h3>이번 달 일정</h3>';
      const monthSchedules = (schedules || [])
        .filter((s) => s.date && s.date.getMonth() === month && s.date.getFullYear() === year)
        .sort((a, b) => a.date - b.date);
      monthSchedules.forEach((s) => {
        const canEdit = currentUser && (currentUser.role === 'admin' || currentUser.id === s.authorId);
        const el = document.createElement('div');
        el.className = 'card';
        const dateStr = s.date ? s.date.toLocaleDateString() : '날짜없음';
        el.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div>
              <strong>${s.title || '제목없음'}</strong><br/>
              <small>${dateStr} ${s.time || ''} | ${s.author || '익명'}</small><br/>
              <span>${s.description || ''}</span>
            </div>
            ${canEdit ? `<button class="btn btn-danger" data-remove-schedule="${s.id}">삭제</button>` : ''}
          </div>`;
        list.appendChild(el);
      });
      container.appendChild(list);
    }

    function loadFinanceBoard() {
      const container = document.getElementById('financeBoard');
      if (!container) return; container.innerHTML = '';
      const now = new Date();
      const year = now.getFullYear();
      const rows = [];
      for (let i = 0; i < 12; i++) {
        const income = (budgetItems || [])
          .filter((it) => it.type === 'income' && it.date && it.date.getMonth() === i && it.date.getFullYear() === year)
          .reduce((s, it) => s + (Number(it.amount) || 0), 0);
        const expense = (budgetItems || [])
          .filter((it) => it.type === 'expense' && it.date && it.date.getMonth() === i && it.date.getFullYear() === year)
          .reduce((s, it) => s + (Number(it.amount) || 0), 0);
        if (income > 0 || expense > 0) rows.push({ month: `${i + 1}월`, income, expense, net: income - expense });
      }
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <h3>${year}년 월별 재정 현황</h3>
        <div style="overflow-x:auto;">
          <table style="width:100%;border-collapse:collapse;margin-top:15px;">
            <thead>
              <tr style="background:#f8f9fa;">
                <th style="padding:10px;border:1px solid #ddd;">월</th>
                <th style="padding:10px;border:1px solid #ddd;">수입</th>
                <th style="padding:10px;border:1px solid #ddd;">지출</th>
                <th style="padding:10px;border:1px solid #ddd;">순수입</th>
              </tr>
            </thead>
            <tbody>
              ${rows
                .map(
                  (m) => `
                <tr>
                  <td style="padding:10px;border:1px solid #ddd;">${m.month}</td>
                  <td style="padding:10px;border:1px solid #ddd;color:#27ae60;">₩${m.income.toLocaleString()}</td>
                  <td style="padding:10px;border:1px solid #ddd;color:#e74c3c;">₩${m.expense.toLocaleString()}</td>
                  <td style="padding:10px;border:1px solid #ddd;color:${m.net >= 0 ? '#27ae60' : '#e74c3c'};">₩${m.net.toLocaleString()}</td>
                </tr>`
                )
                .join('')}
            </tbody>
          </table>
        </div>`;
      container.appendChild(card);
    }

    // ===== 관리자 =====
    function loadAdminPanel() {
      const userList = document.getElementById('userList');
      if (!userList) return; userList.innerHTML = '';
      Object.entries(users).forEach(([id, user]) => {
        const wrap = document.createElement('div');
        wrap.style.cssText = 'display:flex;justify-content:space-between;align-items:center;padding:10px;background:#f8f9fa;border-radius:8px;margin-bottom:10px;';
        wrap.innerHTML = `
          <div>
            <strong>${user.name}</strong> (${id})<br/>
            <small>권한: ${user.role === 'admin' ? '관리자' : '사용자'}</small>
          </div>
          ${id !== 'admin' ? `<button class="btn btn-danger" data-remove-user="${id}">삭제</button>` : ''}
        `;
        userList.appendChild(wrap);
      });
      const systemStats = document.getElementById('systemStats');
      if (systemStats) {
        systemStats.innerHTML = `
          <div style="margin-bottom: 15px;"><strong>총 사용자:</strong> ${Object.keys(users).length}명</div>
          <div style="margin-bottom: 15px;"><strong>총 블로그 포스트:</strong> ${blogPosts.length}개</div>
          <div style="margin-bottom: 15px;"><strong>총 가계부 항목:</strong> ${budgetItems.length}개</div>
          <div style="margin-bottom: 15px;"><strong>총 일정:</strong> ${schedules.length}개</div>
          <div style="margin-top: 20px; display:flex; gap:10px; flex-wrap: wrap;">
            <button class="btn" id="btnExport">데이터 내보내기</button>
            <button class="btn" id="btnClearAll" style="background:#e74c3c;">모든 데이터 삭제</button>
          </div>`;
      }
    }

    function exportData() {
      const data = { users, blogPosts, budgetItems, schedules, exportDate: new Date().toISOString() };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'family_data_' + new Date().toISOString().split('T')[0] + '.json';
      document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    }

    function clearAllData() {
      if (!confirm('정말로 모든 데이터를 삭제하시겠습니까?')) return;
      if (!confirm('다시 한 번 확인합니다. 모든 데이터가 삭제됩니다.')) return;
      blogPosts = []; budgetItems = []; schedules = [];
      saveData(); renderAll(); if (currentUser?.role === 'admin') loadAdminPanel();
      alert('모든 데이터가 삭제되었습니다.');
    }

    // ===== 모달 =====
    function openModal(id) { const m = document.getElementById(id); if (m) m.style.display = 'block'; }
    function closeModal(id) {
      const m = document.getElementById(id); if (!m) return; m.style.display = 'none';
      if (id === 'blogModal') { document.getElementById('blogTitle').value = ''; document.getElementById('blogContent').value = ''; }
      if (id === 'budgetModal') { document.getElementById('budgetDescription').value = ''; document.getElementById('budgetAmount').value = ''; }
      if (id === 'scheduleModal') {
        document.getElementById('scheduleTitle').value = '';
        document.getElementById('scheduleDate').value = '';
        document.getElementById('scheduleTime').value = '';
        document.getElementById('scheduleDescription').value = '';
      }
    }

    // ===== 생성/저장 =====
    async function saveBlogPost() {
      const title = document.getElementById('blogTitle').value.trim();
      const content = document.getElementById('blogContent').value.trim();
      if (!title || !content) return alert('제목과 내용을 모두 입력해주세요.');
      if (!currentUser) return alert('로그인이 필요합니다.');
      const newPost = { id: Date.now(), title, content, author: currentUser.name, authorId: currentUser.id, date: new Date() };
      blogPosts.push(newPost); saveData();
      if (sheetsApiUrl) await saveToSheets('blog', newPost);
      loadBlogPosts(); updateDashboard(); closeModal('blogModal');
    }

    async function saveBudgetItem() {
      const type = document.getElementById('budgetType').value;
      const description = document.getElementById('budgetDescription').value.trim();
      const amount = parseInt(document.getElementById('budgetAmount').value, 10);
      const category = document.getElementById('budgetCategory').value;
      if (!description || isNaN(amount)) return alert('내용과 올바른 금액을 입력해주세요.');
      if (!currentUser) return alert('로그인이 필요합니다.');
      const newItem = { id: Date.now(), type, description, amount, category, author: currentUser.name, authorId: currentUser.id, date: new Date() };
      budgetItems.push(newItem); saveData();
      if (sheetsApiUrl) await saveToSheets('budget', newItem);
      loadBudgetItems(); loadFinanceBoard(); updateDashboard(); closeModal('budgetModal');
    }

    async function saveSchedule() {
      const title = document.getElementById('scheduleTitle').value.trim();
      const dateValue = document.getElementById('scheduleDate').value;
      const time = document.getElementById('scheduleTime').value;
      const description = document.getElementById('scheduleDescription').value.trim();
      if (!title || !dateValue || !time) return alert('제목, 날짜, 시간을 모두 입력해주세요.');
      if (!currentUser) return alert('로그인이 필요합니다.');
      const date = new Date(dateValue); if (isNaN(date.getTime())) return alert('올바른 날짜를 입력해주세요.');
      const newSchedule = { id: Date.now(), title, date, time, description, author: currentUser.name, authorId: currentUser.id };
      schedules.push(newSchedule); saveData();
      if (sheetsApiUrl) await saveToSheets('schedule', newSchedule);
      loadSchedules(); updateDashboard(); closeModal('scheduleModal');
    }

    // ===== 삭제 핸들러 =====
    function removeBlogPost(id) { if (!confirm('정말로 이 포스트를 삭제하시겠습니까?')) return; blogPosts = blogPosts.filter((p) => p.id !== id); saveData(); loadBlogPosts(); updateDashboard(); }
    function removeBudgetItem(id) { if (!confirm('정말로 이 항목을 삭제하시겠습니까?')) return; budgetItems = budgetItems.filter((i) => i.id !== id); saveData(); loadBudgetItems(); loadFinanceBoard(); updateDashboard(); }
    function removeSchedule(id) { if (!confirm('정말로 이 일정을 삭제하시겠습니까?')) return; schedules = schedules.filter((s) => s.id !== id); saveData(); loadSchedules(); updateDashboard(); }
    function removeUser(userId) { if (!users[userId]) return; if (!confirm('정말로 ' + users[userId].name + ' 사용자를 삭제하시겠습니까?')) return; delete users[userId]; loadAdminPanel(); }

    // ===== 이벤트 바인딩 =====
    document.addEventListener('DOMContentLoaded', () => {
      console.log('🚀 가족 관리 시스템 시작');
      const savedUrl = localStorage.getItem('sheetsApiUrl');
      if (savedUrl) { sheetsApiUrl = savedUrl; updateSheetsStatus(true); } else { updateSheetsStatus(false); }
      loadData();

      // 로그인 관련
      document.getElementById('loginBtn').addEventListener('click', loginUser);
      const loginPassword = document.getElementById('loginPassword');
      loginPassword?.addEventListener('keypress', (e) => { if (e.key === 'Enter') loginUser(); });

      // 상단 버튼
      document.getElementById('btnLogout').addEventListener('click', logoutUser);
      document.getElementById('btnSheets').addEventListener('click', () => {
        const url = prompt('Google Apps Script 웹 앱 URL을 입력하세요:\n\n예시: https://script.google.com/macros/s/ABC123.../exec');
        if (url && url.includes('script.google.com/macros')) {
          sheetsApiUrl = url;
          localStorage.setItem('sheetsApiUrl', url);
          updateSheetsStatus(true);
          alert('✅ Google Sheets URL이 저장되었습니다!\n\n이제 데이터가 Google Sheets와 동기화됩니다.');
          testConnection();
        } else if (url) {
          alert('❌ 올바른 Google Apps Script URL을 입력해주세요.\n\n형식: https://script.google.com/macros/s/.../exec');
        }
      });
      document.getElementById('btnSync').addEventListener('click', syncWithSheets);

      // 탭 전환 (event 객체 의존 제거: data-section 사용)
      document.querySelectorAll('.nav-tab').forEach((btn) => {
        btn.addEventListener('click', () => showTab(btn.dataset.section));
      });

      // 모달 오픈 버튼
      document.getElementById('btnNewPost').addEventListener('click', () => openModal('blogModal'));
      document.getElementById('btnNewBudget').addEventListener('click', () => openModal('budgetModal'));
      document.getElementById('btnNewSchedule').addEventListener('click', () => {
        openModal('scheduleModal');
        const today = new Date();
        const dateInput = document.getElementById('scheduleDate');
        if (dateInput) dateInput.value = today.toISOString().split('T')[0];
      });

      // 모달 닫기 (X 버튼)
      document.querySelectorAll('.close').forEach((x) => {
        x.addEventListener('click', () => closeModal(x.dataset.close));
      });

      // 모달 외부 클릭 닫기
      window.addEventListener('click', (e) => {
        document.querySelectorAll('.modal').forEach((m) => { if (e.target === m) m.style.display = 'none'; });
      });

      // 저장 버튼들
      document.getElementById('btnSavePost').addEventListener('click', saveBlogPost);
      document.getElementById('btnSaveBudget').addEventListener('click', saveBudgetItem);
      document.getElementById('btnSaveSchedule').addEventListener('click', saveSchedule);

      // 동적 삭제 버튼 위임
      document.body.addEventListener('click', (e) => {
        const t = e.target;
        if (t.matches('[data-remove-post]')) removeBlogPost(Number(t.getAttribute('data-remove-post')));
        if (t.matches('[data-remove-budget]')) removeBudgetItem(Number(t.getAttribute('data-remove-budget')));
        if (t.matches('[data-remove-schedule]')) removeSchedule(Number(t.getAttribute('data-remove-schedule')));
        if (t.matches('[data-remove-user]')) removeUser(String(t.getAttribute('data-remove-user')));
        if (t.id === 'btnExport') exportData();
        if (t.id === 'btnClearAll') clearAllData();
      });

      // 페이지 종료 시 자동 저장
      window.addEventListener('beforeunload', () => { if (currentUser) saveData(); });

      // 첫 렌더
      renderAll();
      console.log('✅ 초기화 완료');
    });
  </script>
</body>
</html>
