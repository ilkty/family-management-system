<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>우리 가족 통합 관리 시스템</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 15px;
        }

        .login-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            max-width: 450px;
            margin: 80px auto;
        }

        .main-app {
            display: none;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .nav-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .nav-tab {
            background: rgba(255, 255, 255, 0.8);
            border: none;
            padding: 10px 18px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 14px;
        }

        .nav-tab.active {
            background: #667eea;
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .content-section {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .content-section.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            padding: 8px 16px;
            font-size: 12px;
        }

        .card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateX(3px);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 2.2em;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .admin-badge {
            background: #e74c3c;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 10px;
        }

        .expense-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 12px;
        }

        .amount {
            font-weight: bold;
            color: #e74c3c;
        }

        .income {
            color: #27ae60;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            margin: 5% auto;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .close {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }

        .close:hover {
            color: #333;
        }

        @media (max-width: 768px) {
            .container { padding: 10px; }
            .stats-grid { grid-template-columns: 1fr; }
            .expense-item { flex-direction: column; gap: 10px; }
            .user-info { flex-direction: column; text-align: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 로그인 화면 -->
        <div id="loginScreen" class="login-container">
            <h2 style="margin-bottom: 30px; color: #333;">우리 가족 통합 관리 시스템</h2>
            <div class="form-group">
                <label for="loginId">아이디</label>
                <input type="text" id="loginId" placeholder="아이디를 입력하세요">
            </div>
            <div class="form-group">
                <label for="loginPassword">비밀번호</label>
                <input type="password" id="loginPassword" placeholder="비밀번호를 입력하세요">
            </div>
            <button class="btn" onclick="loginUser()">로그인</button>
            <p style="margin-top: 20px; font-size: 12px; color: #666;">
                데모 계정: admin/admin (운영자), dad/dad (아빠), mom/mom (엄마), son/son (아들)
            </p>
        </div>

        <!-- 메인 애플리케이션 -->
        <div id="mainApp" class="main-app">
            <div class="header">
                <div class="user-info">
                    <div>
                        <h1>우리 가족 통합 관리 시스템</h1>
                        <span id="welcomeMessage"></span>
                        <span id="adminBadge" class="admin-badge" style="display: none;">운영자</span>
                    </div>
                    <button class="btn" onclick="setupSheetsUrl()" style="margin-right: 10px; background: #27ae60;">📊 Sheets 연결</button>
                    <button class="btn" onclick="syncWithSheets()" style="margin-right: 10px; background: #3498db;">🔄 동기화</button>
                    <button class="btn" onclick="logoutUser()">로그아웃</button>
                </div>
                <div class="nav-tabs">
                    <button class="nav-tab active" onclick="showTab('dashboard')">대시보드</button>
                    <button class="nav-tab" onclick="showTab('blog')">가족 블로그</button>
                    <button class="nav-tab" onclick="showTab('budget')">가계부</button>
                    <button class="nav-tab" onclick="showTab('calendar')">일정표</button>
                    <button class="nav-tab" onclick="showTab('finance')">재정현황</button>
                    <button class="nav-tab" id="adminTab" style="display: none;" onclick="showTab('admin')">관리자</button>
                </div>
            </div>

            <!-- 대시보드 -->
            <div id="dashboard" class="content-section active">
                <h2>대시보드</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalBudget">₩0</div>
                        <div>이번 달 지출</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="blogCount">0</div>
                        <div>총 블로그 포스트</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="scheduleCount">0</div>
                        <div>이번 주 일정</div>
                    </div>
                </div>
                <h3>최근 활동</h3>
                <div id="recentActivity"></div>
            </div>

            <!-- 가족 블로그 -->
            <div id="blog" class="content-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>가족 블로그</h2>
                    <button class="btn" onclick="openBlogModal()">새 포스트 작성</button>
                </div>
                <div id="blogPosts"></div>
            </div>

            <!-- 가계부 -->
            <div id="budget" class="content-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>가계부</h2>
                    <button class="btn" onclick="openBudgetModal()">수입/지출 추가</button>
                </div>
                <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="stat-card">
                        <div class="stat-number income" id="totalIncome">₩0</div>
                        <div>총 수입</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number amount" id="totalExpense">₩0</div>
                        <div>총 지출</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="netAmount">₩0</div>
                        <div>순수입</div>
                    </div>
                </div>
                <div id="budgetItems"></div>
            </div>

            <!-- 일정표 -->
            <div id="calendar" class="content-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>일정표</h2>
                    <button class="btn" onclick="openScheduleModal()">새 일정 추가</button>
                </div>
                <div id="calendarView"></div>
            </div>

            <!-- 재정현황 -->
            <div id="finance" class="content-section">
                <h2>재정현황 게시판</h2>
                <div id="financeBoard"></div>
            </div>

            <!-- 관리자 페이지 -->
            <div id="admin" class="content-section">
                <h2>관리자 페이지</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div class="card">
                        <h3>사용자 관리</h3>
                        <div id="userList"></div>
                    </div>
                    <div class="card">
                        <h3>시스템 통계</h3>
                        <div id="systemStats"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 블로그 모달 -->
    <div id="blogModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeBlogModal()">&times;</span>
            <h3>새 블로그 포스트 작성</h3>
            <div class="form-group">
                <label>제목</label>
                <input type="text" id="blogTitle">
            </div>
            <div class="form-group">
                <label>내용</label>
                <textarea id="blogContent" rows="6"></textarea>
            </div>
            <button class="btn" onclick="saveBlogPost()">포스트 작성</button>
        </div>
    </div>

    <!-- 가계부 모달 -->
    <div id="budgetModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeBudgetModal()">&times;</span>
            <h3>수입/지출 추가</h3>
            <div class="form-group">
                <label>구분</label>
                <select id="budgetType">
                    <option value="income">수입</option>
                    <option value="expense">지출</option>
                </select>
            </div>
            <div class="form-group">
                <label>내용</label>
                <input type="text" id="budgetDescription">
            </div>
            <div class="form-group">
                <label>금액</label>
                <input type="number" id="budgetAmount">
            </div>
            <div class="form-group">
                <label>카테고리</label>
                <select id="budgetCategory">
                    <option value="식비">식비</option>
                    <option value="교통비">교통비</option>
                    <option value="생활용품">생활용품</option>
                    <option value="의료비">의료비</option>
                    <option value="교육비">교육비</option>
                    <option value="기타">기타</option>
                </select>
            </div>
            <button class="btn" onclick="saveBudgetItem()">추가</button>
        </div>
    </div>

    <!-- 일정 모달 -->
    <div id="scheduleModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeScheduleModal()">&times;</span>
            <h3>새 일정 추가</h3>
            <div class="form-group">
                <label>제목</label>
                <input type="text" id="scheduleTitle">
            </div>
            <div class="form-group">
                <label>날짜</label>
                <input type="date" id="scheduleDate">
            </div>
            <div class="form-group">
                <label>시간</label>
                <input type="time" id="scheduleTime">
            </div>
            <div class="form-group">
                <label>내용</label>
                <textarea id="scheduleDescription" rows="3"></textarea>
            </div>
            <button class="btn" onclick="saveSchedule()">일정 추가</button>
        </div>
    </div>

    <script>
        // 전역 변수
        let currentUser = null;
        let users = {
            admin: { password: 'admin', name: '관리자', role: 'admin' },
            dad: { password: 'dad', name: '아빠', role: 'user' },
            mom: { password: 'mom', name: '엄마', role: 'user' },
            son: { password: 'son', name: '아들', role: 'user' }
        };
        let blogPosts = [];
        let budgetItems = [];
        let schedules = [];

// Google Sheets API 관련 변수
let sheetsApiUrl = '';

// Google Sheets 저장 함수
async function saveToSheets(type, data) {
    if (!sheetsApiUrl) {
        alert('Google Sheets URL을 먼저 설정해주세요.');
        return false;
    }

    try {
        const response = await fetch(sheetsApiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'save',
                type: type,
                data: data
            })
        });
        const result = await response.json();
        return result.success;
    } catch (error) {
        console.error('Sheets 저장 오류:', error);
        return false;
    }
}

// URL 저장 함수
function saveSheetsUrl() {
    const url = prompt('Google Apps Script 웹 앱 URL을 입력하세요:');
    if (url) {
        sheetsApiUrl = url;
        localStorage.setItem('sheetsApiUrl', url);
        alert('URL이 저장되었습니다!');
    }
}
        
        // 데이터 저장
        function saveData() {
            try {
                const data = {
                    blogPosts: blogPosts,
                    budgetItems: budgetItems,
                    schedules: schedules,
                    lastSaved: new Date().toISOString()
                };
                localStorage.setItem('familyData', JSON.stringify(data));
            } catch (error) {
                console.error('저장 오류:', error);
            }
        }

        // 데이터 로드
        function loadData() {
            try {
                const data = localStorage.getItem('familyData');
                if (data) {
                    const parsed = JSON.parse(data);
                    blogPosts = parsed.blogPosts || [];
                    budgetItems = parsed.budgetItems || [];
                    schedules = parsed.schedules || [];
                    
                    // 날짜 변환
                    blogPosts = blogPosts.map(post => ({
                        ...post,
                        date: new Date(post.date)
                    }));
                    budgetItems = budgetItems.map(item => ({
                        ...item,
                        date: new Date(item.date)
                    }));
                    schedules = schedules.map(schedule => ({
                        ...schedule,
                        date: new Date(schedule.date)
                    }));
                } else {
                    // 초기 데이터
                    blogPosts = [{
                        id: 1,
                        title: '가족 여행 계획',
                        content: '이번 여름휴가 계획을 세워보았습니다.',
                        author: '엄마',
                        date: new Date('2025-08-01'),
                        authorId: 'mom'
                    }];
                    budgetItems = [
                        {
                            id: 1,
                            type: 'expense',
                            description: '마트 장보기',
                            amount: 150000,
                            category: '식비',
                            author: '엄마',
                            date: new Date('2025-08-20'),
                            authorId: 'mom'
                        },
                        {
                            id: 2,
                            type: 'income',
                            description: '월급',
                            amount: 3000000,
                            category: '급여',
                            author: '아빠',
                            date: new Date('2025-08-01'),
                            authorId: 'dad'
                        }
                    ];
                    schedules = [{
                        id: 1,
                        title: '가족 외식',
                        date: new Date('2025-08-25'),
                        time: '18:00',
                        description: '저녁 외식',
                        author: '엄마',
                        authorId: 'mom'
                    }];
                    saveData();
                }
            } catch (error) {
                console.error('로드 오류:', error);
            }
        }

        // 로그인
        function loginUser() {
            const id = document.getElementById('loginId').value;
            const password = document.getElementById('loginPassword').value;

            if (users[id] && users[id].password === password) {
                currentUser = { id, ...users[id] };
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                document.getElementById('welcomeMessage').textContent = currentUser.name + '님 환영합니다!';
                
                if (currentUser.role === 'admin') {
                    document.getElementById('adminBadge').style.display = 'inline-block';
                    document.getElementById('adminTab').style.display = 'block';
                }
                
                loadData();
                updateDashboard();
                loadBlogPosts();
                loadBudgetItems();
                loadFinanceBoard();
                if (currentUser.role === 'admin') {
                    loadAdminPanel();
                }
            } else {
                alert('아이디 또는 비밀번호가 올바르지 않습니다.');
            }
        }

        // 로그아웃
        function logoutUser() {
            currentUser = null;
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('adminBadge').style.display = 'none';
            document.getElementById('adminTab').style.display = 'none';
            document.getElementById('loginId').value = '';
            document.getElementById('loginPassword').value = '';
            showTab('dashboard');
        }

        // 탭 전환
        function showTab(section) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(section).classList.add('active');
            event.target.classList.add('active');
        }

        // 대시보드 업데이트
        function updateDashboard() {
            const currentMonth = new Date().getMonth();
            const monthlyExpenses = budgetItems
                .filter(item => item.type === 'expense' && item.date.getMonth() === currentMonth)
                .reduce((sum, item) => sum + item.amount, 0);
            
            document.getElementById('totalBudget').textContent = '₩' + monthlyExpenses.toLocaleString();
            document.getElementById('blogCount').textContent = blogPosts.length;
            document.getElementById('scheduleCount').textContent = schedules.length;

            const recentActivity = document.getElementById('recentActivity');
            recentActivity.innerHTML = '';
            
            const recent = [
                ...blogPosts.slice(-3),
                ...budgetItems.slice(-3),
                ...schedules.slice(-3)
            ].sort((a, b) => b.date - a.date).slice(0, 5);

            recent.forEach(activity => {
                const card = document.createElement('div');
                card.className = 'card';
                
                let content = '';
                if (activity.title && activity.content) {
                    content = activity.author + '님이 "' + activity.title + '" 블로그 포스트를 작성했습니다.';
                } else if (activity.description && activity.amount) {
                    const type = activity.type === 'income' ? '수입' : '지출';
                    content = activity.author + '님이 ' + type + ' "' + activity.description + '"을(를) ₩' + activity.amount.toLocaleString() + '으로 기록했습니다.';
                } else if (activity.title && activity.time) {
                    content = activity.author + '님이 "' + activity.title + '" 일정을 추가했습니다.';
                }
                
                card.innerHTML = '<p><strong>' + content + '</strong></p><small style="color: #666;">' + activity.date.toLocaleDateString() + '</small>';
                recentActivity.appendChild(card);
            });
        }

        // 블로그 포스트 로드
        function loadBlogPosts() {
            const container = document.getElementById('blogPosts');
            container.innerHTML = '';
            
            blogPosts.sort((a, b) => b.date - a.date).forEach(post => {
                const canEdit = currentUser.role === 'admin' || currentUser.id === post.authorId;
                const postElement = document.createElement('div');
                postElement.className = 'card';
                postElement.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <h3 style="margin-bottom: 10px;">${post.title}</h3>
                            <p style="margin-bottom: 10px;">${post.content}</p>
                            <small style="color: #666;">작성자: ${post.author} | 날짜: ${post.date.toLocaleDateString()}</small>
                        </div>
                        ${canEdit ? `<button class="btn btn-danger" onclick="removeBlogPost(${post.id})" style="margin-left: 10px;">삭제</button>` : ''}
                    </div>
                `;
                container.appendChild(postElement);
            });
        }

        // 가계부 항목 로드
        function loadBudgetItems() {
            const container = document.getElementById('budgetItems');
            container.innerHTML = '';
            
            let totalIncome = 0;
            let totalExpense = 0;
            
            budgetItems.sort((a, b) => b.date - a.date).forEach(item => {
                if (item.type === 'income') {
                    totalIncome += item.amount;
                } else {
                    totalExpense += item.amount;
                }
                
                const canEdit = currentUser.role === 'admin' || currentUser.id === item.authorId;
                const itemElement = document.createElement('div');
                itemElement.className = 'expense-item';
                itemElement.innerHTML = `
                    <div>
                        <strong>${item.description}</strong><br>
                        <small>카테고리: ${item.category} | ${item.author} | ${item.date.toLocaleDateString()}</small>
                    </div>
                    <div style="text-align: right;">
                        <div class="${item.type === 'income' ? 'income' : 'amount'}">${item.type === 'income' ? '+' : '-'}₩${item.amount.toLocaleString()}</div>
                        ${canEdit ? `<button class="btn btn-danger" onclick="removeBudgetItem(${item.id})" style="margin-top: 5px;">삭제</button>` : ''}
                    </div>
                `;
                container.appendChild(itemElement);
            });
            
            document.getElementById('totalIncome').textContent = '₩' + totalIncome.toLocaleString();
            document.getElementById('totalExpense').textContent = '₩' + totalExpense.toLocaleString();
            document.getElementById('netAmount').textContent = '₩' + (totalIncome - totalExpense).toLocaleString();
        }

        // 재정현황 로드
        function loadFinanceBoard() {
            const container = document.getElementById('financeBoard');
            container.innerHTML = '';
            
            const currentYear = new Date().getFullYear();
            const months = [];
            
            for (let i = 0; i < 12; i++) {
                const monthlyIncome = budgetItems
                    .filter(item => item.type === 'income' && item.date.getMonth() === i && item.date.getFullYear() === currentYear)
                    .reduce((sum, item) => sum + item.amount, 0);
                
                const monthlyExpense = budgetItems
                    .filter(item => item.type === 'expense' && item.date.getMonth() === i && item.date.getFullYear() === currentYear)
                    .reduce((sum, item) => sum + item.amount, 0);
                
                if (monthlyIncome > 0 || monthlyExpense > 0) {
                    months.push({
                        month: (i + 1) + '월',
                        income: monthlyIncome,
                        expense: monthlyExpense,
                        net: monthlyIncome - monthlyExpense
                    });
                }
            }
            
            const summaryCard = document.createElement('div');
            summaryCard.className = 'card';
            summaryCard.innerHTML = `
                <h3>${currentYear}년 월별 재정 현황</h3>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 10px; border: 1px solid #ddd;">월</th>
                                <th style="padding: 10px; border: 1px solid #ddd;">수입</th>
                                <th style="padding: 10px; border: 1px solid #ddd;">지출</th>
                                <th style="padding: 10px; border: 1px solid #ddd;">순수입</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${months.map(m => `
                                <tr>
                                    <td style="padding: 10px; border: 1px solid #ddd;">${m.month}</td>
                                    <td style="padding: 10px; border: 1px solid #ddd; color: #27ae60;">₩${m.income.toLocaleString()}</td>
                                    <td style="padding: 10px; border: 1px solid #ddd; color: #e74c3c;">₩${m.expense.toLocaleString()}</td>
                                    <td style="padding: 10px; border: 1px solid #ddd; color: ${m.net >= 0 ? '#27ae60' : '#e74c3c'};">₩${m.net.toLocaleString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            container.appendChild(summaryCard);
        }

        // 관리자 패널 로드
        function loadAdminPanel() {
            const userList = document.getElementById('userList');
            userList.innerHTML = '';
            
            Object.entries(users).forEach(([id, user]) => {
                const userElement = document.createElement('div');
                userElement.style.cssText = 'display:flex;justify-content:space-between;align-items:center;padding:10px;background:#f8f9fa;border-radius:8px;margin-bottom:10px;';
                userElement.innerHTML = `
                    <div>
                        <strong>${user.name}</strong> (${id})<br>
                        <small>권한: ${user.role === 'admin' ? '관리자' : '사용자'}</small>
                    </div>
                    ${id !== 'admin' ? `<button class="btn btn-danger" onclick="removeUser('${id}')">삭제</button>` : ''}
                `;
                userList.appendChild(userElement);
            });
            
            const systemStats = document.getElementById('systemStats');
            systemStats.innerHTML = `
                <div style="margin-bottom: 15px;"><strong>총 사용자:</strong> ${Object.keys(users).length}명</div>
                <div style="margin-bottom: 15px;"><strong>총 블로그 포스트:</strong> ${blogPosts.length}개</div>
                <div style="margin-bottom: 15px;"><strong>총 가계부 항목:</strong> ${budgetItems.length}개</div>
                <div style="margin-bottom: 15px;"><strong>총 일정:</strong> ${schedules.length}개</div>
                <div style="margin-top: 20px;">
                    <button class="btn" onclick="exportData()">데이터 내보내기</button>
                    <button class="btn" onclick="clearAllData()" style="margin-left: 10px; background: #e74c3c;">모든 데이터 삭제</button>
                </div>
            `;
        }

        // 모달 함수들
        function openBlogModal() {
            document.getElementById('blogModal').style.display = 'block';
        }

        function closeBlogModal() {
            document.getElementById('blogModal').style.display = 'none';
            document.getElementById('blogTitle').value = '';
            document.getElementById('blogContent').value = '';
        }

        function openBudgetModal() {
            document.getElementById('budgetModal').style.display = 'block';
        }

        function closeBudgetModal() {
            document.getElementById('budgetModal').style.display = 'none';
            document.getElementById('budgetDescription').value = '';
            document.getElementById('budgetAmount').value = '';
        }

        function openScheduleModal() {
            document.getElementById('scheduleModal').style.display = 'block';
            const today = new Date();
            document.getElementById('scheduleDate').value = today.toISOString().split('T')[0];
        }

        function closeScheduleModal() {
            document.getElementById('scheduleModal').style.display = 'none';
            document.getElementById('scheduleTitle').value = '';
            document.getElementById('scheduleDate').value = '';
            document.getElementById('scheduleTime').value = '';
            document.getElementById('scheduleDescription').value = '';
        }

  // 수정된 블로그 저장 함수
        async function saveBlogPost() {
            const title = document.getElementById('blogTitle').value;
            const content = document.getElementById('blogContent').value;
            
            if (title && content) {
                const newPost = {
                    id: Date.now(),
                    title: title,
                    content: content,
                    author: currentUser.name,
                    authorId: currentUser.id,
                    date: new Date()
                };
                
                blogPosts.push(newPost);
                saveData(); // 로컬 저장
                
                // Google Sheets에도 저장
                await saveToSheets('blog', newPost);
                
                loadBlogPosts();
                updateDashboard();
                closeBlogModal();
            } else {
                alert('제목과 내용을 모두 입력해주세요.');
            }
        }

        function saveBudgetItem() {
            const type = document.getElementById('budgetType').value;
            const description = document.getElementById('budgetDescription').value;
            const amount = parseInt(document.getElementById('budgetAmount').value);
            const category = document.getElementById('budgetCategory').value;
            
            if (description && amount) {
                const newItem = {
                    id: Date.now(),
                    type: type,
                    description: description,
                    amount: amount,
                    category: category,
                    author: currentUser.name,
                    authorId: currentUser.id,
                    date: new Date()
                };
                budgetItems.push(newItem);
                saveData();
                loadBudgetItems();
                loadFinanceBoard();
                updateDashboard();
                closeBudgetModal();
            } else {
                alert('내용과 금액을 모두 입력해주세요.');
            }
        }

        function saveSchedule() {
            const title = document.getElementById('scheduleTitle').value;
            const date = new Date(document.getElementById('scheduleDate').value);
            const time = document.getElementById('scheduleTime').value;
            const description = document.getElementById('scheduleDescription').value;
            
            if (title && date && time) {
                const newSchedule = {
                    id: Date.now(),
                    title: title,
                    date: date,
                    time: time,
                    description: description,
                    author: currentUser.name,
                    authorId: currentUser.id
                };
                schedules.push(newSchedule);
                saveData();
                updateDashboard();
                closeScheduleModal();
            } else {
                alert('제목, 날짜, 시간을 모두 입력해주세요.');
            }
        }

        // 삭제 함수들
        function removeBlogPost(id) {
            if (confirm('정말로 이 포스트를 삭제하시겠습니까?')) {
                blogPosts = blogPosts.filter(post => post.id !== id);
                saveData();
                loadBlogPosts();
                updateDashboard();
            }
        }

        function removeBudgetItem(id) {
            if (confirm('정말로 이 항목을 삭제하시겠습니까?')) {
                budgetItems = budgetItems.filter(item => item.id !== id);
                saveData();
                loadBudgetItems();
                loadFinanceBoard();
                updateDashboard();
            }
        }

        function removeUser(userId) {
            if (confirm('정말로 ' + users[userId].name + ' 사용자를 삭제하시겠습니까?')) {
                delete users[userId];
                loadAdminPanel();
            }
        }

        // 관리자 기능
        function exportData() {
            const data = {
                users: users,
                blogPosts: blogPosts,
                budgetItems: budgetItems,
                schedules: schedules,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'family_data_' + new Date().toISOString().split('T')[0] + '.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function clearAllData() {
            if (confirm('정말로 모든 데이터를 삭제하시겠습니까?')) {
                if (confirm('다시 한 번 확인합니다. 모든 데이터가 삭제됩니다.')) {
                    blogPosts = [];
                    budgetItems = [];
                    schedules = [];
                    saveData();
                    updateDashboard();
                    loadBlogPosts();
                    loadBudgetItems();
                    loadFinanceBoard();
                    loadAdminPanel();
                    alert('모든 데이터가 삭제되었습니다.');
                }
            }
        }

        // 모달 외부 클릭 시 닫기
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        };

        // 초기화
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            
            // 엔터 키로 로그인
            document.getElementById('loginPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    loginUser();
                }
            });
            
            // 페이지 종료 시 자동 저장
            window.addEventListener('beforeunload', function() {
                if (currentUser) {
                    saveData();
                }
            });
        });
    </script>
</body>
</html>
